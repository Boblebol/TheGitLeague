ğŸ“„ 1) PRD.md

# ğŸ€ The Git League â€” PRD

## 1.1 Vision & Positioning

### ğŸ¯ Pitch produit
**The Git League** transforme lâ€™activitÃ© Git de ton entreprise en **league NBA** : stats, classements, awards, â€œplays of the dayâ€, saisons, fantasy league â€” le tout **auto-hÃ©bergeable** et **open source**.

### ğŸ˜– ProblÃ¨me rÃ©solu (pain points)
- **Aucune vision fun + actionnable** de la contribution : Git log brut, dashboards froids, pas dâ€™engagement.
- **Reconnaissance biaisÃ©e** (les â€œvisible commitsâ€ / grosses features) : pas de highlights, pas de palmarÃ¨s, pas dâ€™awards rÃ©guliers.
- **Difficile dâ€™animer une Ã©quipe** : pas de saisons, pas de rythme (joueur de la semaine/mois), pas de â€œstorylineâ€.
- **Multi-projets** : contributions dispersÃ©es, impossible de comparer / agrÃ©ger proprement.
- **Self-host** : besoin dâ€™un outil qui ne pousse pas les donnÃ©es code vers un SaaS externe.

### ğŸ‘¥ Target audience
**Persona principal : â€œCommissionerâ€ (Engineering Manager / Tech Lead / Head of Eng)**
- Objectif : animer, mesurer, cÃ©lÃ©brer, structurer les saisons, gÃ©rer les accÃ¨s.

**Secondaires**
- **Players** (dÃ©veloppeurs/contributeurs) : veulent leurs stats, palmarÃ¨s, progression, reconnaissance.
- **Spectators** (PM/Design/QA/Stakeholders) : veulent suivre sans Ã©crire, accÃ¨s contrÃ´lÃ©.

### ğŸ† USP (Unique Selling Proposition)
- **Gamification NBA-native** + **Fantasy league** sur des mÃ©triques Git **normalisÃ©es** (anti-biais).
- **Auto-hÃ©bergeable**, compatible environnements entreprise (RBAC, audit, rÃ©tention, pas dâ€™exfiltration).
- **Multi-repos / multi-projets** avec **saisons** et **HOF** (Hall of Fame) pour historiser proprement.

---

## 1.2 Features V1 (MVP) â€” DÃ‰TAILLÃ‰ES

> Objectif MVP : Ingestion Git fiable + stats + ladder + profils + rÃ´les + saisons + awards basiques + fantasy simple.

### âœ… Feature A â€” Onboarding & Auth (RBAC)
**Description**
- Auth via email + lien magique (ou SSO optionnel post-V1).
- 3 rÃ´les : **Commissioner**, **Player**, **Spectator** (spectateurs nÃ©cessitent validation).
- Matching â€œPlayerâ€ via **emails connus dans les commits** (ou mapping manuel).

**User stories**
- En tant que **commissioner**, je veux inviter des utilisateurs et dÃ©finir leur rÃ´le, pour contrÃ´ler lâ€™accÃ¨s.
- En tant que **player**, je veux me connecter et Ãªtre automatiquement associÃ© Ã  mes commits, pour voir mes stats.
- En tant que **spectator**, je veux demander lâ€™accÃ¨s, pour suivre la league sans contribuer.

**CritÃ¨res dâ€™acceptation**
- [ ] Login email + token Ã  usage unique (expiration 15 min).
- [ ] Un utilisateur peut avoir plusieurs identitÃ©s Git (emails multiples).
- [ ] Un spectator nâ€™accÃ¨de Ã  rien tant que non approuvÃ©.
- [ ] Audit minimal : qui a approuvÃ© qui + quand.

**PrioritÃ©** : **Must-have**

---

### âœ… Feature B â€” Gestion multi-projets & repos (Commissioner console)
**Description**
- Un "Project" = collection de repos.
- Un repo est configurÃ© avec : URL/chemin, mode d'accÃ¨s (local bare / SSH / HTTPS token), branche(s) suivie(s), frÃ©quence de sync, fenÃªtres d'absence.
- **Gestion sÃ©curisÃ©e des Personal Access Tokens (PAT)** :
  - Un mÃªme PAT peut Ãªtre utilisÃ© pour plusieurs repos (factorisation)
  - Tokens stockÃ©s chiffrÃ©s (Fernet AES-128) dans `repos.encrypted_credentials`
  - Jamais exposÃ©s dans les API responses ou logs
  - DÃ©cryptÃ©s uniquement au moment du sync Git (in-memory)

**User stories**
- En tant que **commissioner**, je veux crÃ©er un projet et y attacher plusieurs repos, pour centraliser la league.
- En tant que **commissioner**, je veux configurer un PAT pour accÃ©der Ã  plusieurs repos privÃ©s, sans le ressaisir Ã  chaque fois.
- En tant que **commissioner**, je veux Ãªtre sÃ»r que mes tokens sont stockÃ©s de maniÃ¨re sÃ©curisÃ©e, pour protÃ©ger l'accÃ¨s aux repos.
- En tant que **commissioner**, je veux configurer les rÃ¨gles d'ingestion, pour maÃ®triser performance & sÃ©curitÃ©.

**CritÃ¨res d'acceptation**
- [ ] CRUD Project.
- [ ] CRUD Repo avec statut : `healthy / syncing / error`.
- [ ] ParamÃ¨tres : branches, "since date", frÃ©quence (cron-like simple), exclusions (paths optionnels V1.1).
- [ ] Ã‰cran "last sync" + "last commit ingested" (sha).
- [ ] **SÃ©curitÃ© PAT** :
  - [ ] Encryption des credentials au repos (Fernet)
  - [ ] API ne retourne jamais les tokens dÃ©cryptÃ©s
  - [ ] Audit log de tous les accÃ¨s aux credentials
  - [ ] Rate limiting sur endpoints de crÃ©ation/modification repos

**PrioritÃ©** : **Must-have**

---

### âœ… Feature C â€” Ingestion Git â†’ DB (ETL)
**Description**
- Extraction des commits + stats diff : sha, author name/email, committer name/email, date, message (titre + body), additions, deletions, files changed (optionnel), parents, branch.
- Ingestion incrÃ©mentale par repo, idempotente.

**User stories**
- En tant que **commissioner**, je veux synchroniser les repos, pour avoir des stats Ã  jour.
- En tant que **systÃ¨me**, je veux Ã©viter les doublons, pour garantir des classements corrects.

**CritÃ¨res dâ€™acceptation**
- [ ] Ingestion incrÃ©mentale (par `last_ingested_sha` ou `max(commit_date)` + fallback).
- [ ] Idempotence : relancer une sync ne duplique pas.
- [ ] Gestion rÃ©org / force-push : stratÃ©gie V1 â€œbest effortâ€ (marquer commits orphelins, ne pas casser).
- [ ] Perf : 100k commits ingÃ©rÃ©s < 5 minutes sur machine dev correcte (objectif), avec pagination/streaming.
- [ ] Logs structurÃ©s + page â€œsync errorsâ€ par repo.

**PrioritÃ©** : **Must-have**

---

### âœ… Feature D â€” Stats Core & Normalisation â€œNBA-basedâ€
**Description**
- Calcul des mÃ©triques brutes (Git) + mÃ©triques dÃ©rivÃ©es (NBA).
- Exemples bruts : commits, additions, deletions, net lines, â€œimpact indexâ€.
- Exemples NBA : PTS/REB/AST/BLK/STL/TOV (mapping configurable par commissioner).

**Mapping recommandÃ© (V1)**
- **PTS** = additions (capÃ©es) + commits pondÃ©rÃ©s
- **REB** = deletions (capÃ©es) (ou â€œcleanupâ€)
- **AST** = commits touchant plusieurs fichiers (proxy collaboration) OU commits non-triviaux Ã  faible churn (option)
- **BLK** = revert / fix commit dÃ©tectÃ© (simple heuristique â€œfix|bug|hotfixâ€)
- **TOV** = commits â€œwip|tmp|debugâ€ ou trÃ¨s hauts churn sans message clair (heuristique)

> Important : V1 = heuristiques simples + **transparence** (â€œcomment câ€™est calculÃ©â€) + rÃ©glages.

**User stories**
- En tant que **player**, je veux voir mes stats â€œsaisonâ€ et â€œcarriÃ¨reâ€, pour suivre ma progression.
- En tant que **commissioner**, je veux ajuster les coefficients, pour coller Ã  la culture de lâ€™Ã©quipe.

**CritÃ¨res dâ€™acceptation**
- [ ] Page â€œRulesâ€ expliquant mapping + coefficients.
- [ ] Coefficients modifiables (par projet) sans migration (table config).
- [ ] Recalcule possible sur une saison (job asynchrone).
- [ ] Affichage â€œbrutâ€ + â€œNBAâ€ cÃ´te Ã  cÃ´te.

**PrioritÃ©** : **Must-have**

---

### âœ… Feature E â€” Saisons, pÃ©riodes, absences (League engine)
**Description**
- Une saison = intervalle [start, end] + statut (draft / active / closed).
- PÃ©riodes : week / month (dÃ©rivÃ©es des dates).
- Absences : intervals par player (exclure des awards/leaderboards optionnel).

**User stories**
- En tant que **commissioner**, je veux dÃ©finir une saison, pour cadrer la compÃ©tition.
- En tant que **commissioner**, je veux enregistrer une absence, pour Ã©viter de pÃ©naliser un joueur.

**CritÃ¨res dâ€™acceptation**
- [ ] CRUD Saison + activation (1 active max par projet).
- [ ] Leaderboards filtrables : â€œSaisonâ€, â€œCette semaineâ€, â€œCe moisâ€.
- [ ] Absence : exclure du â€œplayer of week/monthâ€ (option ON/OFF par rÃ¨gle).

**PrioritÃ©** : **Must-have**

---

### âœ… Feature F â€” Leaderboards & Ladder board
**Description**
- Classements par mÃ©triques (NBA points, commits, impact index).
- Vues : global projet, par repo, par pÃ©riode.
- â€œStreaksâ€ (jours actifs) V1 simple.

**User stories**
- En tant que **spectator**, je veux voir le classement, pour suivre la league.
- En tant que **player**, je veux comparer mes stats Ã  dâ€™autres, pour me situer.

**CritÃ¨res dâ€™acceptation**
- [ ] Ladder triable par mÃ©trique.
- [ ] Filtres : saison/pÃ©riode, repo, role (players only).
- [ ] Perf : leaderboard < 300ms pour 200 joueurs / 1M commits (avec agrÃ©gations prÃ©-calculÃ©es).

**PrioritÃ©** : **Must-have**

---

### âœ… Feature G â€” Profils joueurs (carriÃ¨re + palmarÃ¨s)
**Description**
- Page profil : stats saison, carriÃ¨re, historiques, awards.
- Graphs simples : trend weekly/monthly.

**User stories**
- En tant que **player**, je veux un profil avec mes stats et rÃ©compenses, pour avoir mon â€œplayer cardâ€.
- En tant que **commissioner**, je veux consulter un joueur, pour comprendre sa contribution.

**CritÃ¨res dâ€™acceptation**
- [ ] Profil accessible via leaderboard + recherche.
- [ ] Sections : â€œSaisonâ€, â€œCarriÃ¨reâ€, â€œAwardsâ€, â€œReposâ€.
- [ ] Graphs : commits/PTS par semaine (12-24 points).

**PrioritÃ©** : **Must-have**

---

### âœ… Feature H â€” Awards & Highlights (V1)
**Description**
- Awards automatiques :
  - Player of the Week
  - Player of the Month
  - MVP (fin de saison)
  - Most Improved (comparaison saison N vs N-1)
- â€œPlay of the Dayâ€ = meilleur commit du jour (score composite).

**User stories**
- En tant que **player**, je veux gagner des awards, pour Ãªtre reconnu.
- En tant que **spectator**, je veux voir les highlights, pour suivre les moments forts.

**CritÃ¨res dâ€™acceptation**
- [ ] Calcul automatique, deterministic, expliquÃ© (score breakdown).
- [ ] â€œPlay of the Dayâ€ montre : message, stats diff, repo, auteur, date.
- [ ] Exclure merges (option ON/OFF) pour Ã©viter bruit.

**PrioritÃ©** : **Must-have**

---

### âœ… Feature I â€” Fantasy League (simple draft + scoring)
**Description**
- Commissioner crÃ©e une â€œFantasy Leagueâ€ par saison.
- RÃ¨gle V1 : chaque participant choisit **1 Ã  5 contributeurs** (pool dÃ©fini par commissioner).
- Scoring : somme des PTS/REB/ASTâ€¦ des joueurs choisis sur la pÃ©riode.

**User stories**
- En tant que **commissioner**, je veux dÃ©finir le pool de joueurs draftables, pour cadrer le jeu.
- En tant que **participant fantasy**, je veux choisir mon roster, pour marquer des points.

**CritÃ¨res dâ€™acceptation**
- [ ] Draft mode : â€œpick listâ€ (pas besoin de tour par tour V1) OU â€œsnake draftâ€ (option).
- [ ] Un roster respecte min/max (1..5).
- [ ] Leaderboard fantasy par pÃ©riode + total saison.
- [ ] Lock du roster aprÃ¨s date limite.

**PrioritÃ©** : **Should-have** (mais trÃ¨s centrale Ã  lâ€™identitÃ©)

---

### âœ… Feature J â€” Hall of Fame (HOF) + Retraites
**Description**
- Marquer un joueur â€œretiredâ€.
- HOF = agrÃ©gation all-time, records, top awards.

**User stories**
- En tant que **commissioner**, je veux retirer un joueur, pour garder lâ€™historique propre.
- En tant que **spectator**, je veux voir le HOF, pour cÃ©lÃ©brer les lÃ©gendes.

**CritÃ¨res dâ€™acceptation**
- [ ] Flag â€œretiredâ€ (nâ€™apparaÃ®t plus dans saisons futures).
- [ ] HOF page : top 10 all-time + records (commits, PTS, awards).
- [ ] Historique inchangÃ© : les saisons passÃ©es restent cohÃ©rentes.

**PrioritÃ©** : **Should-have**

---

### ğŸ§© Options ambiguÃ«s (choix Ã  trancher)
1) **Scoring â€œNBAâ€**
- **Option A (simple, robuste)** : additions/deletions/commits + caps + coefficients âœ…
- **Option B (plus â€œqualitÃ©â€)** : intÃ©grer PRs/reviews/issues (post-V1) â• mais dÃ©pend plateforme

2) **Fantasy Draft**
- **Option A** : sÃ©lection libre (rapide, moins fun)
- **Option B** : snake draft avec timer (plus fun, plus UX Ã  construire)

3) **Ingestion**
- **Option A** : cloner repos localement (bare) sur le serveur (simple, perf)
- **Option B** : lire via API GitHub/GitLab (moins stockage, mais API limits + auth complexe)

---

## 1.3 Features Post-V1

### Phase 2 (3â€“6 mois) â€” â€œclassiquesâ€
- ğŸ” Recherche commits & plays (S) â€” full-text sur messages/auteurs/repos
- ğŸ§  Anti-biais amÃ©liorÃ© (M) â€” caps dynamiques, â€œgarbage timeâ€, exclusion merges/squash rules
- ğŸ§© Tags & â€œSeasons narrativesâ€ (S) â€” thÃ¨mes, recap auto
- ğŸ‘¥ Teams / Squads (M) â€” classements par Ã©quipe/tribu
- ğŸ”” Notifications (M) â€” Slack/Email : awards, play of day, weekly recap
- ğŸ§¾ Export CSV/JSON (S) â€” pour BI interne
- ğŸ” SSO (SAML/OIDC) (L) â€” entreprises

### Phase 3 (6â€“12 mois) â€” IA & avancÃ©es
- ğŸ¤– â€œCommit quality coachâ€ (L) â€” suggestions sur messages, dÃ©tection WIP, conventions
- ğŸ§  Clustering auto des contributions (M) â€” regrouper par feature/area via embeddings (self-host)
- ğŸ—ï¸ â€œImpact estimationâ€ (L) â€” relier commits Ã  modules critiques / ownership (via code graph)
- ğŸ§‘â€âš–ï¸ Awards semi-assistÃ©s (M) â€” propose nominees + vote interne
- ğŸ”Œ IntÃ©grations (M/L) â€” GitHub/GitLab/Bitbucket, Jira/Linear, Slack, Teams


â¸»

âŒ¨ï¸ 2) SHORTCUTS.md

# âŒ¨ï¸ The Git League â€” Raccourcis Clavier

> App web : on privilÃ©gie des raccourcis **in-app** type â€œSlack/Notionâ€.
> âš ï¸ Les raccourcis â€œglobauxâ€ sont limitÃ©s par le navigateur (pas de vrai global hotkey).
> On Ã©vite les collisions VS Code / Chrome (ex: âŒ˜L, âŒ˜T, âŒ˜W, âŒ˜Râ€¦).

## Raccourcis â€œQuasi-Globauxâ€ (fonctionnent quand lâ€™onglet est actif)
| Raccourci | Action | PrioritÃ© |
|-----------|--------|----------|
| âŒ˜K | Ouvrir la Command Palette | Critique |
| âŒ˜/ | Ouvrir lâ€™aide raccourcis | Important |
| Esc | Fermer modales / drawers | Critique |
| âŒ˜Enter | Confirmer action principale (dans modales) | Important |

## In-App â€” Navigation
| Raccourci | Action |
|-----------|--------|
| g Ø«Ù… l (g puis l) | Aller au **Leaderboard** |
| g Ø«Ù… p | Aller Ã  **Mon Profil** |
| g Ø«Ù… a | Aller Ã  **Awards** |
| g Ø«Ù… f | Aller Ã  **Fantasy** |
| g Ø«Ù… s | Aller Ã  **Settings** (si commissioner) |
| âŒ¥â† / âŒ¥â†’ | Naviguer pÃ©riode prÃ©cÃ©dente/suivante (week/month) |

> â€œg puis â€¦â€ imite GitHub (mnÃ©monique, peu de conflits).

## In-App â€” Recherche & filtres
| Raccourci | Action |
|-----------|--------|
| / | Focus sur recherche (si prÃ©sente) |
| âŒ˜F | Focus recherche interne (NE PAS hijack le find du navigateur si possible) |
| âŒ¥1..âŒ¥5 | Basculer mÃ©trique (PTS/REB/AST/â€¦ config) |
| âŒ¥R | Filtre repo (ouvrir dropdown) |
| âŒ¥T | Filtre pÃ©riode (week/month/season) |

## In-App â€” Leaderboard
| Raccourci | Action |
|-----------|--------|
| â†‘ / â†“ | Naviguer dans la liste |
| Enter | Ouvrir profil du joueur sÃ©lectionnÃ© |
| Space | â€œPinâ€/suivre un joueur (favori) |
| âŒ˜D | Ouvrir dÃ©tail score (breakdown) |

## In-App â€” Profil joueur
| Raccourci | Action |
|-----------|--------|
| 1 | Tab â€œSaisonâ€ |
| 2 | Tab â€œCarriÃ¨reâ€ |
| 3 | Tab â€œAwardsâ€ |
| 4 | Tab â€œReposâ€ |
| âŒ¥H | Aller au Hall of Fame |

## In-App â€” Fantasy
| Raccourci | Action |
|-----------|--------|
| âŒ˜N | Nouveau roster / modifier sÃ©lection |
| âŒ˜S | Sauver roster |
| âŒ˜L | Lock roster (si autorisÃ©) |
| âŒ¥â†‘ / âŒ¥â†“ | RÃ©ordonner picks |

## In-App â€” Commissioner Console
| Raccourci | Action |
|-----------|--------|
| âŒ˜N | Nouveau projet / repo / saison (selon page) |
| âŒ˜S | Sauvegarder config |
| âŒ˜B | Lancer sync (bouton â€œSync nowâ€) |
| âŒ˜â‡§L | Ouvrir logs de sync |

## Principes de design (raccourcis)
- âœ… MnÃ©moniques : K=command, g=go, f=fantasy, l=leaderboard
- âœ… Pas de collisions majeures navigateur : Ã©viter âŒ˜T, âŒ˜L, âŒ˜R, âŒ˜W
- âœ… Aide intÃ©grÃ©e : âŒ˜/ affiche la liste contextualisÃ©e par page


â¸»

ğŸ› ï¸ 3) TECHNICAL_STACK.md

# ğŸ› ï¸ The Git League â€” Technical Stack

## 3.1 Architecture recommandÃ©e

### Option recommandÃ©e (simple, robuste, self-host) âœ…
- **Frontend** : Next.js (App Router) + TypeScript + Tailwind + shadcn/ui
- **Backend API** : Python **FastAPI**
- **Jobs/Workers** : Python (Celery/RQ) OU worker Rust dÃ©diÃ© si ingestion massive
- **DB** : PostgreSQL
- **Cache/Queue** : Redis (pour jobs + rate limiting)
- **DÃ©ploiement** : Docker Compose + Dokploy

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Frontend (Web)       â”‚        â”‚           Backend           â”‚
â”‚ Next.js + TS + shadcn/ui    â”‚ <----> â”‚ FastAPI (REST) + OpenAPI    â”‚
â”‚ TanStack Query (cache)      â”‚        â”‚ Auth + RBAC + League Engine â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                       â”‚
               â”‚                                       â”‚ enqueue jobs
               â”‚                                       â–¼
               â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                          â”‚      Worker / Scheduler      â”‚
               â”‚                          â”‚ Git ingestion + recompute    â”‚
               â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                         â”‚
               â–¼                                         â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   Postgres    â”‚ <---------------------- â”‚   Repo storage (bare) â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–²
                    â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚  Redis  â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Option performance (si trÃ¨s gros repos) âš¡
	â€¢	Remplacer le worker ingestion par un binaire Rust (libgit2) qui pousse en DB (ou via API interne).
	â€¢	Utile si : millions de commits, besoin de parsing ultra rapide, CPU bound.

â¸»

3.2 BibliothÃ¨ques clÃ©s

Frontend (npm)
	â€¢	next / react / typescript
	â€¢	Usage : app web (routing, SSR/CSR hybride)
	â€¢	@tanstack/react-query
	â€¢	Usage : cache API, invalidation aprÃ¨s recompute/sync
	â€¢	Alternative : SWR (plus simple, moins â€œstate machineâ€)
	â€¢	tailwindcss + shadcn/ui + lucide-react
	â€¢	Usage : UI cohÃ©rente + velocity dev
	â€¢	zod
	â€¢	Usage : validation cÃ´tÃ© front (schemas partagÃ©s possibles)
	â€¢	react-hook-form
	â€¢	Usage : forms settings (repos, seasons, coefficients)
	â€¢	recharts (ou visx)
	â€¢	Usage : graphs simples (trend weekly/monthly)
	â€¢	Alternative : Chart.js (ok, parfois plus lourd)

Backend (Python)
	â€¢	fastapi + uvicorn
	â€¢	Usage : API REST + docs OpenAPI
	â€¢	sqlalchemy + alembic
	â€¢	Usage : ORM + migrations (schema Ã©volutif)
	â€¢	Alternative : sqlmodel (plus simple, moins flexible)
	â€¢	psycopg (v3)
	â€¢	Usage : driver Postgres moderne
	â€¢	python-jose (ou pyjwt)
	â€¢	Usage : tokens magic-link / sessions
	â€¢	passlib[argon2]
	â€¢	Usage : si tu ajoutes mot de passe (optionnel)
	â€¢	cryptography
	â€¢	Usage : encryption des PAT tokens avec Fernet (AES-128 + HMAC-SHA256)
	â€¢	Critique : sÃ©curitÃ© des credentials pour repos privÃ©s
	â€¢	celery + redis
	â€¢	Usage : jobs sync + recompute + awards
	â€¢	Alternative : rq (plus simple), dramatiq (clean)
	â€¢	slowapi
	â€¢	Usage : rate limiting sur endpoints sensibles (credentials)
	â€¢	Alternative : fastapi-limiter

Ingestion Git
	â€¢	Option Python : GitPython
	â€¢	Usage : accÃ©der Ã  git log facilement
	â€¢	Limite : performance sur trÃ¨s gros repos
	â€¢	Option Rust (recommandÃ©e si scale) : git2 (libgit2 bindings)
	â€¢	Usage : extraction commits/diffs efficace
	â€¢	Alternative : CLI git log --numstat (simple, mais parsing fragile)

Liens (Ã  garder en code pour Ã©viter markdown brut) :
	â€¢	https://www.npmjs.com/package/@tanstack/react-query
	â€¢	https://pypi.org/project/fastapi/
	â€¢	https://crates.io/crates/git2

â¸»

3.3 ConsidÃ©rations techniques critiques

âš¡ Performance (objectifs mesurables)
	â€¢	Ingestion :
	â€¢	100k commits : < 5 min (objectif)
	â€¢	1M commits : < 30 min (avec worker Rust recommandÃ©)
	â€¢	Leaderboards :
	â€¢	requÃªtes UI < 300ms sur 200 joueurs / 1M commits
	â€¢	Recompute saison :
	â€¢	job async + progress + verrouillage (Ã©viter double recompute)

ğŸ—„ï¸ Stockage & croissance DB
	â€¢	Tables â€œrawâ€ (commits) + tables â€œaggregatesâ€ (par player/pÃ©riode)
	â€¢	StratÃ©gie :
	â€¢	conserver raw commits (nÃ©cessaire all-time/HOF)
	â€¢	recalculer aggregates via jobs (idempotents)
	â€¢	Index indispensables :
	â€¢	(repo_id, commit_date), (author_email_normalized), (season_id, player_id)

ğŸ” SÃ©curitÃ©
	â€¢	Pas de code source stockÃ© : uniquement mÃ©tadonnÃ©es (sha, numstat, message)
	â€¢	Secrets repo :
	â€¢	stockÃ©s chiffrÃ©s (ex: Fernet) ou via variables Dokploy
	â€¢	RBAC strict :
	â€¢	endpoints commissioner protÃ©gÃ©s
	â€¢	Audit minimal :
	â€¢	approbations spectators, changements rules, lancement sync

â™»ï¸ Updates & DÃ©ploiement
	â€¢	Docker images versionnÃ©es
	â€¢	Migrations Alembic au boot (avec lock)
	â€¢	â€œMaintenance modeâ€ si migration cassante
	â€¢	CI/CD : GitHub Actions (lint, tests, build docker, security scan)

â¸»

3.4 ModÃ¨le de donnÃ©es (V1 â€” tables principales)

Core
	â€¢	users : id, email, role, status(approved/pending), created_at
	â€¢	git_identities : id, user_id, git_name, git_email_normalized
	â€¢	projects : id, name, slug
	â€¢	repos : id, project_id, name, remote_url, access_type(local_bare|ssh|https_pat),
	         encrypted_credentials(JSONB), encryption_key_id, branch, last_sync_at,
	         last_ingested_sha, status, error_message, created_at, updated_at
	â€¢	commits : sha(pk or unique), repo_id, author_name, author_email_norm, commit_date, message_title, message_body,
additions, deletions, files_changed, is_merge, parent_count
	â€¢	audit_logs : id, event_type, user_id, resource_type, resource_id, metadata(JSONB),
	              ip_address, user_agent, created_at

League
	â€¢	seasons : id, project_id, name, start_at, end_at, status
	â€¢	absences : id, season_id, user_id, start_at, end_at, reason

Aggregates (prÃ©-calculÃ©s)
	â€¢	player_period_stats : season_id, period_type(day/week/month/season/all_time), period_start,
user_id, commits, additions, deletions, pts, reb, ast, blk, stl, tov, impact_score

Awards / Highlights
	â€¢	awards : season_id, period_type, period_start, award_type, user_id, score, metadata_json
	â€¢	plays : day(date), repo_id, sha, user_id, score, reason_json

Fantasy
	â€¢	fantasy_leagues : season_id, name, roster_min, roster_max, lock_at
	â€¢	fantasy_participants : league_id, user_id
	â€¢	fantasy_rosters : league_id, user_id, created_at, locked_at
	â€¢	fantasy_roster_picks : roster_id, picked_user_id (unique per roster)

---

## ğŸ¨ 4) UX_GUIDELINES.md

```markdown
# ğŸ¨ The Git League â€” UX Guidelines

## 4.1 Principes de design

- âš¡ **Speed first** : toute action (tri, filtre, navigation) donne un feedback <200ms.
- ğŸ§  **Explainability** : chaque score NBA/award doit Ãªtre â€œcliquableâ€ â†’ dÃ©tail de calcul.
- âŒ¨ï¸ **Keyboard-centric** : Command Palette (âŒ˜K) partout.
- ğŸ‘€ **Storytelling** : on ne montre pas juste des nombres â†’ â€œPlay of the dayâ€, awards, records.
- ğŸ§© **Enterprise-safe** : pas de fuites (pas de code), permissions visibles, pages protÃ©gÃ©es.

---

## 4.2 Flows utilisateurs clÃ©s

### FLOW 1 â€” Setup dâ€™un projet (Commissioner)
1. User : ouvre **Settings â†’ Projects**
2. App : bouton â€œâ• New Projectâ€
3. User : crÃ©e projet + slug
4. App : Ã©cran â€œAdd Reposâ€
5. User : ajoute repo (remote + branch + frÃ©quence sync)
6. App : â€œSync nowâ€ + progression
7. App : â€œSeason wizardâ€ â†’ crÃ©er saison active
8. App : page â€œRulesâ€ pour rÃ©gler coefficients NBA

### FLOW 2 â€” Player login & association identitÃ© Git
1. User : entre email
2. App : envoie lien magique
3. User : clique lien
4. App : si email match des commits â†’ associe automatiquement
5. Sinon : App propose â€œClaim identityâ€ (liste des emails Git dÃ©tectÃ©s) + validation commissioner (option)

### FLOW 3 â€” Consulter un Play of the Day
1. User : va sur â€œHighlightsâ€
2. App : liste par jour (cards)
3. User : ouvre une card
4. App : montre dÃ©tail commit (sha, repo, message, additions/deletions) + â€œscore breakdownâ€
5. User : clique auteur â†’ profil joueur

### FLOW 4 â€” Fantasy roster
1. User : va sur â€œFantasyâ€
2. App : affiche pool draftable + rÃ¨gles (min/max + lock date)
3. User : sÃ©lectionne 1..5 joueurs
4. App : calcule score estimÃ© + validation
5. User : sauvegarde puis lock

---

## 4.3 Composants UI principaux

### A) Global Shell (Top nav + command palette)
- Topbar : Project switcher, Season switcher, Search, User menu
- Command Palette : navigation + actions commissioner + help

**Interactions**
- âŒ˜K ouvre palette
- Esc ferme
- rÃ©sultats keyboard-navigable

---

### B) Leaderboard (Ladder board)

**Wireframe**
```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ† Leaderboard   [Project â–¼] [Season â–¼]   Metric: [PTS â–¼]     â”‚
â”‚ Filter: [Repo â–¼] [Week/Month/Season â–¼]     Search: [____]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ #  Player                PTS   REB   AST   BLK   TOV  Trend   â”‚
â”‚ 1  Alice "The Builder"   124   52    31    4     9    â†—ï¸      â”‚
â”‚ 2  Bob "Cleanup King"    118   70    18    2     5    â†’      â”‚
â”‚ 3  ChloÃ© "Playmaker"     111   40    45    1     7    â†—ï¸      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰tats
	â€¢	Vide : â€œNo commits ingested yetâ€ + CTA â€œSync nowâ€ (commissioner)
	â€¢	Loading : skeleton rows
	â€¢	Error : message + bouton â€œView sync logsâ€

â¸»

C) Profil joueur (â€œPlayer Cardâ€)

Wireframe

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Alice â€” SG   [Follow â˜†]   Status: Active                     â”‚
â”‚ Season: 2026 S1   Tabs: [1 Season] [2 Career] [3 Awards]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PTS 124  REB 52  AST 31  BLK 4  TOV 9   Impact 78            â”‚
â”‚ Trend (weekly graph)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ… Awards: Player of Week x2, MVP x1                          â”‚
â”‚ ğŸ“Œ Best Plays: [commit cardsâ€¦]                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Interactions
	â€¢	Click mÃ©trique â†’ ouvre breakdown (sources : commits, caps, coefficients)
	â€¢	Tabs via 1/2/3

â¸»

D) Commissioner Console

Wireframe

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš™ï¸ Commissioner Console                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Projects  Repos  Seasons  Rules  Access  Sync Logs           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Repos: [repo-a] status: healthy  last sync: 10:32            â”‚
â”‚       [repo-b] status: error    last sync: 09:10 [View logs] â”‚
â”‚ [Sync now] [Recompute season]                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰tats
	â€¢	Logs paginÃ©s + filtre par repo + export JSON

â¸»

4.4 AccessibilitÃ©
	â€¢	âœ… Focus visible partout (shadcn + ring Tailwind)
	â€¢	âœ… Navigation clavier complÃ¨te (tab order logique + roving tabindex sur lists)
	â€¢	âœ… Contraste WCAG AA
	â€¢	âœ… Labels ARIA sur palette, dropdowns, graphiques (fallback tableau)

---

## ğŸš€ 5) ROADMAP_AND_GTM.md

```markdown
# ğŸš€ The Git League â€” Roadmap & GTM

## 5.1 Roadmap technique (timeline indicatif â€” solo dev)

### Semaine 1â€“2 : Foundation âœ…
- [ ] Repo mono (frontend + backend) + Docker compose (Postgres/Redis)
- [ ] Next.js + shadcn/ui + layout global + auth UI
- [ ] FastAPI skeleton + OpenAPI + RBAC middleware
- [ ] **Module encryption (Fernet) + config management**
- [ ] SchÃ©ma Postgres + Alembic migrations (avec encrypted_credentials)
- [ ] ModÃ¨le Projects/Repos/Users/Git identities
- [ ] **Audit logs table + rate limiting**

### Semaine 3â€“4 : Ingestion Git (Core) ğŸ§±
- [ ] Repo config + secrets (env/Dokploy)
- [ ] **API endpoints pour CRUD repos avec PAT encryption**
- [ ] Worker + queue (Celery/RQ)
- [ ] **Worker : dÃ©cryption sÃ©curisÃ©e des credentials pour Git sync**
- [ ] Ingestion incrÃ©mentale + idempotence
- [ ] Logs structurÃ©s + Ã©cran Sync status
- [ ] PremiÃ¨re agrÃ©gation "raw â†’ player_period_stats"

### Semaine 5â€“6 : League Engine ğŸ€
- [ ] Saisons (CRUD + active)
- [ ] Mapping NBA + coefficients configurables
- [ ] Leaderboards (season/week/month) + performance indexes
- [ ] Profils joueurs (season + career)

### Semaine 7â€“8 : Awards + Highlights âœ¨
- [ ] Player of week/month + MVP saison (jobs)
- [ ] Play of the day (score composite + card UI)
- [ ] Hall of Fame (all-time aggregates)
- [ ] Retired players

### Semaine 9â€“10 : Fantasy (V1) ğŸ®
- [ ] Fantasy league entity + participants
- [ ] Draft â€œpick listâ€ (simple) + lock date
- [ ] Fantasy leaderboard + pages roster

### Semaine 11â€“12 : Hardening & OSS polish ğŸ§¼
- [ ] Tests (API + jobs) + seed demo dataset
- [ ] Rate limiting + audit minimal
- [ ] ObservabilitÃ© : logs JSON + healthchecks
- [ ] Docs : README, self-host guide, env vars, screenshots
- [ ] GitHub Actions : lint/test/build docker + release tags

---

## 5.2 Go-To-Market Strategy (Open Source + Self-host)

### Positionnement produit
- **Tagline** : â€œTurn your Git into an NBA season.â€
- **Elevator pitch (30s)** :
  â€œThe Git League ingÃ¨re vos commits et les transforme en league NBA : leaderboards, awards, plays du jour et fantasy league â€” entiÃ¨rement self-hosted. Parfait pour animer une Ã©quipe sans exposer le code Ã  un SaaS.â€

### ICP (idÃ©al)
- Ã‰quipes 5â€“200 devs
- Culture craft/engineering + envie de fun (rituels hebdo)
- Contraintes privacy (banques, santÃ©, infra interne)

### Canaux
1. **GitHub (OSS)**
   - README bÃ©ton + GIF + â€œQuickstart Dockerâ€
   - â€œDemo modeâ€ (dataset inclus)
2. **HackerNews â€” Show HN**
   - Angle : â€œself-hosted + fun + explainable metricsâ€
3. **Reddit**
   - r/selfhosted, r/devops, r/programming, r/opensource
4. **Dev.to / Medium**
   - Article : â€œHow I turned git history into an NBA fantasy leagueâ€
5. **CommunautÃ©s**
   - Discord dev, Slack internes, plateformes engineering

### Distribution â€œenterprise-friendlyâ€
- Docker images signÃ©es (phase 2)
- Helm chart (phase 2)
- Documentation â€œAir-gapped friendlyâ€

---

## 5.3 Analyse concurrentielle

| Concurrent | Prix | Forces | Faiblesses | Notre avantage |
|-----------|------|--------|------------|----------------|
| GitHub Insights / Pulse | Inclus | Facile, intÃ©grÃ© | Peu fun, peu custom | Gamification + saisons + fantasy |
| GitLab Analytics | Inclus | Metrics standard | UX lourde, pas narrative | Explainability + awards + HOF |
| Outils â€œDev productivityâ€ SaaS | $$$ | Dashboards riches | DonnÃ©es externalisÃ©es | Self-host + privacy + fun |
| Tableaux maison (BI) | Temps | Sur-mesure | CoÃ»t maintenance, pas jeu | PackagÃ© + prÃªt Ã  dÃ©ployer |

**Positionnement compÃ©titif**
- On nâ€™essaie pas de â€œmesurer la productivitÃ©â€ au sens HR.
- On fait une **league** : transparence, cÃ©lÃ©bration, narration, et contrÃ´le (coefficients + exclusions).

---

## 5.4 MÃ©triques de succÃ¨s (OSS)

### Semaine 1 (aprÃ¨s release v0.1)
- 200 â­ GitHub
- 20 installs â€œrÃ©ellesâ€ (issues/discussions)
- 5 retours sur scoring (coeffs)

### Mois 1 (v1.0)
- 1k â­ GitHub
- 100 installs
- 10 contributions externes (PR/docs)
- < 1h â€œtime-to-first-leaderboardâ€ (objectif UX)

### Mois 3
- 3k â­ GitHub
- 300 installs
- 3 intÃ©grations demandÃ©es de faÃ§on rÃ©pÃ©tÃ©e (signal roadmap)
- Taux de rÃ©tention : 50% des installs actives (sync hebdo)

---

## Annexes â€” Score composite â€œPlay of the Dayâ€ (V1)
Proposition dÃ©terministe (explainable) :
- base = `pts * 1.0 + reb * 0.6 + ast * 0.8 + blk * 1.2 - tov * 0.7`
- bonus :
  - +X si message â€œfix/bugâ€ (blk)
  - -X si â€œwip/tmpâ€
- exclusions optionnelles :
  - merges
  - commits > cap additions/deletions (anti â€œspam diffâ€)


â¸»

Si tu veux, je peux aussi te gÃ©nÃ©rer un schÃ©ma SQL V1 complet (Postgres) + un plan d'API endpoints FastAPI (routes + DTO Zod) alignÃ© sur ces docs.


â¸»

ğŸ” 6) SECURITY.md

# ğŸ” The Git League â€” Security Architecture

## 6.1 Principes de sÃ©curitÃ© fondamentaux

### ğŸ¯ Objectifs de sÃ©curitÃ©
- **ConfidentialitÃ©** : Aucun code source stockÃ©, seulement des mÃ©tadonnÃ©es (SHA, stats, messages)
- **IntÃ©gritÃ©** : Credentials chiffrÃ©s au repos, jamais exposÃ©s dans les logs ou API
- **DisponibilitÃ©** : Self-hosted, pas de dÃ©pendance SaaS externe
- **AuditabilitÃ©** : TraÃ§abilitÃ© de tous les accÃ¨s aux credentials et changements de configuration
- **ConformitÃ©** : Compatible environnements entreprise (RBAC, retention, air-gapped)

---

## 6.2 Gestion des Personal Access Tokens (PAT)

### Architecture d'encryption

**ProblÃ¨me adressÃ©** :
- Les commissioners doivent pouvoir configurer des repositories privÃ©s (GitHub/GitLab/Bitbucket)
- Un mÃªme PAT peut Ãªtre utilisÃ© pour plusieurs repositories (factorisation)
- Les tokens doivent Ãªtre stockÃ©s de maniÃ¨re sÃ©curisÃ©e dans la base de donnÃ©es

**Solution : Encryption at-rest avec Fernet**

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Flux d'encryption/decryption                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Commissioner (UI)                                               â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”‚ POST /api/repos {"name": "...", "pat": "ghp_xxx..."}    â”‚
â”‚       â–¼                                                          â”‚
â”‚  FastAPI Endpoint (RBAC: commissioner only)                      â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”‚ encrypt(pat, ENCRYPTION_MASTER_KEY)                      â”‚
â”‚       â–¼                                                          â”‚
â”‚  Database (repos.encrypted_credentials)                          â”‚
â”‚       â”‚ â†’ {"type": "pat", "token": "gAAAAA...encrypted..."}      â”‚
â”‚       â”‚                                                          â”‚
â”‚  [Sync Job triggered]                                            â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”‚ fetch repo config                                        â”‚
â”‚       â–¼                                                          â”‚
â”‚  Worker (Git Ingestion)                                          â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”‚ decrypt(encrypted_token, ENCRYPTION_MASTER_KEY)          â”‚
â”‚       â”‚ â†’ "ghp_xxx..." (en mÃ©moire seulement)                    â”‚
â”‚       â–¼                                                          â”‚
â”‚  Git Clone/Fetch (HTTPS with PAT)                                â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”‚ clear memory (token wiped)                               â”‚
â”‚       â–¼                                                          â”‚
â”‚  Commits ingested â†’ DB                                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### BibliothÃ¨que : `cryptography` (Fernet)

**Fernet** est un algorithme de chiffrement symÃ©trique authentifiÃ© (AES-128-CBC + HMAC-SHA256) :
- âœ… Simple Ã  utiliser (API haut niveau)
- âœ… IntÃ©gritÃ© garantie (HMAC empÃªche la modification)
- âœ… Timestamp inclus (permet expiration optionnelle)
- âœ… Standard Python (via `cryptography` library)

**Installation** :
```bash
pip install cryptography
```

**Exemple de code** :
```python
from cryptography.fernet import Fernet
import os

# GÃ©nÃ©ration de la clÃ© master (Ã  faire une seule fois, stocker en env var)
master_key = Fernet.generate_key()  # ex: b'3x...32 bytes base64...'

# Encryption
cipher = Fernet(master_key)
encrypted_token = cipher.encrypt(b"ghp_yourPATtoken123")
# â†’ b'gAAAAABl...[donnÃ©es chiffrÃ©es]...'

# Decryption
decrypted_token = cipher.decrypt(encrypted_token)
# â†’ b'ghp_yourPATtoken123'
```

---

## 6.3 SchÃ©ma de donnÃ©es pour credentials

### Table `repos` (mise Ã  jour)

```sql
CREATE TABLE repos (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    remote_url TEXT NOT NULL,  -- URL sans credentials (ex: https://github.com/owner/repo.git)

    -- Nouveau : Gestion des credentials
    access_type VARCHAR(50) NOT NULL,  -- 'local_bare' | 'ssh' | 'https_pat'
    encrypted_credentials JSONB,       -- Structure chiffrÃ©e (voir ci-dessous)
    encryption_key_id VARCHAR(50) DEFAULT 'v1',  -- Pour rotation de clÃ©s (phase 2)

    -- MÃ©tadonnÃ©es sync
    branch VARCHAR(255) DEFAULT 'main',
    last_sync_at TIMESTAMP,
    last_ingested_sha VARCHAR(40),
    status VARCHAR(50) DEFAULT 'pending',  -- 'pending' | 'healthy' | 'syncing' | 'error'
    error_message TEXT,

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_repos_project_id ON repos(project_id);
CREATE INDEX idx_repos_status ON repos(status);
```

### Structure du champ `encrypted_credentials` (JSONB)

**Avant encryption** (objet JSON en clair) :
```json
{
  "type": "pat",
  "token": "ghp_yourActualPATtoken123",
  "username": "git"  // optionnel, pour HTTPS auth
}
```

**AprÃ¨s encryption** (stockÃ© dans `repos.encrypted_credentials`) :
```json
{
  "type": "pat",
  "encrypted_data": "gAAAAABl3x...base64_encrypted_payload...",
  "algorithm": "fernet",
  "key_version": "v1"
}
```

Le champ `encrypted_data` contient :
- Le token PAT chiffrÃ©
- Le username (si nÃ©cessaire)
- Tout autre secret (SSH private key pour accÃ¨s SSH en phase 2)

---

## 6.4 Configuration & gestion de la clÃ© master

### Variables d'environnement (CRITIQUES)

**Fichier `.env` (JAMAIS commitÃ© dans Git)** :
```bash
# Encryption (MASTER KEY - CRITIQUE)
ENCRYPTION_MASTER_KEY=3x4mpl3K3yB4s364...  # 32 bytes base64 (gÃ©nÃ©rÃ© via Fernet.generate_key())

# Alternative : utiliser un service de secrets management
# Ex: Dokploy secrets, Vault, AWS Secrets Manager, etc.

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/thegitleague

# API Security
SECRET_KEY=your-jwt-secret-key-min-32-chars
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=15

# Environment
ENVIRONMENT=production  # development | production
DEBUG=false
```

### GÃ©nÃ©ration de la clÃ© master (one-time setup)

**Script utilitaire** : `backend/scripts/generate_encryption_key.py`
```python
from cryptography.fernet import Fernet

def generate_master_key():
    """GÃ©nÃ¨re une clÃ© master Fernet (32 bytes base64)."""
    key = Fernet.generate_key()
    print("ğŸ”‘ ENCRYPTION_MASTER_KEY (GARDEZ-LA SECRÃˆTE) :")
    print(key.decode())
    print("\nâš ï¸  IMPORTANT :")
    print("1. Ajoutez cette clÃ© Ã  votre .env : ENCRYPTION_MASTER_KEY=<key>")
    print("2. Ne commitez JAMAIS cette clÃ© dans Git")
    print("3. Sauvegardez-la dans un gestionnaire de secrets (Vault, 1Password, etc.)")
    print("4. Si vous perdez cette clÃ©, tous les PAT seront irrÃ©cupÃ©rables")

if __name__ == "__main__":
    generate_master_key()
```

**Utilisation** :
```bash
python backend/scripts/generate_encryption_key.py
# â†’ Copier la clÃ© gÃ©nÃ©rÃ©e dans .env
```

### Rotation de clÃ©s (phase 2 â€” optionnel V1)

Pour permettre la rotation de clÃ©s sans downtime :
1. Ajouter `encryption_key_id` dans `repos` (ex: `v1`, `v2`)
2. Stocker plusieurs clÃ©s dans l'environnement : `ENCRYPTION_KEY_V1`, `ENCRYPTION_KEY_V2`
3. DÃ©chiffrer avec la clÃ© correspondante (`encryption_key_id`)
4. Lors de la rotation : dÃ©chiffrer avec ancienne clÃ©, rechiffrer avec nouvelle clÃ©

**Exemple de config multi-clÃ©s** :
```bash
ENCRYPTION_KEY_V1=old-key...
ENCRYPTION_KEY_V2=new-key...
ENCRYPTION_KEY_CURRENT=v2  # Nouvelle clÃ© par dÃ©faut
```

---

## 6.5 Bonnes pratiques de sÃ©curitÃ©

### ğŸ”’ Stockage & accÃ¨s aux credentials

**DO âœ…**
- Chiffrer TOUS les secrets au repos (PAT, SSH keys, API tokens)
- Utiliser des variables d'environnement ou un secret manager (Vault, Dokploy secrets)
- DÃ©chiffrer uniquement au moment de l'utilisation (dans le worker)
- Nettoyer la mÃ©moire aprÃ¨s utilisation (`del token`, pas de logs)
- Limiter l'accÃ¨s aux endpoints de credentials (RBAC : commissioner only)

**DON'T âŒ**
- âŒ Stocker des tokens en clair dans la DB
- âŒ Logger les tokens (mÃªme partiellement)
- âŒ Retourner les tokens dÃ©cryptÃ©s dans les rÃ©ponses API
- âŒ Committer `.env` ou fichiers contenant des secrets
- âŒ Utiliser des tokens personnels (crÃ©er un compte "bot" dÃ©diÃ©)

### ğŸ” Audit & monitoring

**Ã‰vÃ©nements Ã  auditer** (table `audit_logs`) :
- CrÃ©ation/modification/suppression de repos avec credentials
- AccÃ¨s aux credentials pour sync Git
- Changements de configuration RBAC
- Approbations de spectators
- Modifications de rÃ¨gles de scoring

**Structure recommandÃ©e** :
```sql
CREATE TABLE audit_logs (
    id SERIAL PRIMARY KEY,
    event_type VARCHAR(100) NOT NULL,  -- 'repo.credentials.accessed', 'repo.created', etc.
    user_id INTEGER REFERENCES users(id),
    resource_type VARCHAR(50),  -- 'repo', 'project', 'season'
    resource_id INTEGER,
    metadata JSONB,  -- DÃ©tails (SANS secrets)
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_event_type ON audit_logs(event_type);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
```

**Exemple d'audit log** :
```json
{
  "event_type": "repo.credentials.accessed",
  "user_id": null,  // AccÃ¨s par worker (pas un user)
  "resource_type": "repo",
  "resource_id": 42,
  "metadata": {
    "action": "git_sync",
    "repo_name": "myorg/backend",
    "success": true,
    "duration_ms": 3421
  },
  "created_at": "2025-12-28T10:32:15Z"
}
```

### ğŸ›¡ï¸ Rate limiting & protection

**Endpoints sensibles** :
- `POST /api/repos` (crÃ©ation avec credentials)
- `PUT /api/repos/{id}` (modification credentials)
- `POST /api/repos/{id}/sync` (dÃ©clenchement sync)

**StratÃ©gie** :
- Rate limiting : max 10 req/min par commissioner pour endpoints credentials
- ImplÃ©mentation : Redis + middleware FastAPI
- Lockout temporaire aprÃ¨s 5 Ã©checs d'auth consÃ©cutifs

**Exemple (FastAPI)** :
```python
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.post("/api/repos", dependencies=[Depends(require_commissioner)])
@limiter.limit("10/minute")
async def create_repo(request: Request, repo: RepoCreate):
    # ...
```

### ğŸ” RBAC strict

**Matrice d'accÃ¨s** :

| Endpoint | Commissioner | Player | Spectator |
|----------|--------------|--------|-----------|
| `GET /api/repos` | âœ… (liste complÃ¨te) | âœ… (liste sans credentials) | âœ… (si approved) |
| `POST /api/repos` | âœ… | âŒ | âŒ |
| `PUT /api/repos/{id}` | âœ… | âŒ | âŒ |
| `DELETE /api/repos/{id}` | âœ… | âŒ | âŒ |
| `POST /api/repos/{id}/sync` | âœ… | âŒ | âŒ |
| `GET /api/repos/{id}` | âœ… (avec metadata) | âœ… (sans credentials) | âœ… (si approved) |

**ImplÃ©mentation FastAPI** :
```python
from fastapi import Depends, HTTPException, status
from backend.core.auth import get_current_user

def require_commissioner(user = Depends(get_current_user)):
    if user.role != "commissioner":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="This action requires commissioner role"
        )
    return user
```

---

## 6.6 SÃ©curitÃ© rÃ©seau & dÃ©ploiement

### ğŸŒ DÃ©ploiement self-hosted (Docker Compose)

**Recommandations** :
- âœ… Utiliser un reverse proxy (Traefik, Nginx) avec HTTPS (Let's Encrypt)
- âœ… Isoler la DB dans un rÃ©seau Docker privÃ© (pas d'exposition publique)
- âœ… Limiter les ports ouverts : seulement 80/443 (HTTP/HTTPS)
- âœ… Configurer les secrets via Docker secrets ou Dokploy

**Exemple `docker-compose.yml` (extrait)** :
```yaml
version: "3.9"

services:
  backend:
    build: ./backend
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/thegitleague
      # âš ï¸ SECRETS via fichier .env (pas en clair ici)
    env_file:
      - .env  # Contient ENCRYPTION_MASTER_KEY
    networks:
      - app-network
    depends_on:
      - db
      - redis

  db:
    image: postgres:16
    environment:
      POSTGRES_DB: thegitleague
      POSTGRES_USER: user
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # Variable d'env
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - app-network
    # Pas de ports exposÃ©s publiquement (seulement accessible via app-network)

  redis:
    image: redis:7-alpine
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  postgres-data:
```

### ğŸ”¥ Firewall & accÃ¨s

**RÃ¨gles recommandÃ©es** :
- Autoriser : ports 80/443 (frontend + API)
- Bloquer : port 5432 (Postgres), 6379 (Redis) depuis l'extÃ©rieur
- Optionnel : VPN/Tailscale pour accÃ¨s admin (commissioner console)

---

## 6.7 ConformitÃ© & certifications (roadmap phase 2)

### Objectifs entreprise

**V1** :
- âœ… Encryption at-rest (Fernet)
- âœ… RBAC
- âœ… Audit logs
- âœ… Self-hosted (pas d'exfiltration)

**Phase 2** :
- ğŸ”œ Encryption in-transit (HTTPS obligatoire)
- ğŸ”œ Backup chiffrÃ© (Postgres + secrets)
- ğŸ”œ SSO/SAML (authentification entreprise)
- ğŸ”œ RÃ©tention configurable (RGPD : droit Ã  l'oubli)
- ğŸ”œ Pen-test + security audit

**Phase 3** :
- ğŸ”œ SOC 2 Type II (si version SaaS future)
- ğŸ”œ ISO 27001 compliance
- ğŸ”œ Air-gapped mode (pas de dÃ©pendances externes)

---

## 6.8 Gestion des incidents & recovery

### ğŸš¨ ScÃ©narios de compromission

#### ScÃ©nario 1 : Fuite de la clÃ© master (`ENCRYPTION_MASTER_KEY`)

**Impact** : Un attaquant peut dÃ©chiffrer tous les PAT stockÃ©s.

**Actions immÃ©diates** :
1. RÃ©voquer TOUS les PAT sur les plateformes (GitHub/GitLab)
2. GÃ©nÃ©rer une nouvelle clÃ© master (`Fernet.generate_key()`)
3. RÃ©gÃ©nÃ©rer de nouveaux PAT
4. Re-chiffrer les credentials avec la nouvelle clÃ©
5. Investiguer comment la clÃ© a fuitÃ© (logs, audit)

**PrÃ©vention** :
- Stocker la clÃ© dans un secret manager (Vault, AWS Secrets Manager)
- Limiter l'accÃ¨s au fichier `.env` (permissions 600, owner-only)
- Pas de commit de `.env` dans Git (`.gitignore`)

#### ScÃ©nario 2 : Base de donnÃ©es compromise

**Impact** : Les credentials chiffrÃ©s sont exposÃ©s, mais inutilisables sans la clÃ© master.

**Actions** :
1. VÃ©rifier si la clÃ© master est Ã©galement compromise
2. Si non : les credentials restent protÃ©gÃ©s (Fernet = AES + HMAC)
3. Si oui : suivre ScÃ©nario 1
4. Restaurer la DB depuis un backup propre
5. Renforcer les accÃ¨s DB (firewall, rÃ©seau privÃ©)

#### ScÃ©nario 3 : Compte commissioner compromis

**Impact** : Un attaquant peut crÃ©er/modifier des repos et voir les mÃ©tadonnÃ©es (mais pas dÃ©chiffrer les PAT via l'API).

**Actions** :
1. Suspendre le compte commissioner compromis
2. Auditer les actions rÃ©centes (table `audit_logs`)
3. RÃ©voquer les tokens de session
4. Forcer MFA (phase 2)
5. Notifier les autres commissioners

---

## 6.9 Checklist de dÃ©ploiement sÃ©curisÃ©

**Avant de dÃ©ployer en production** :
- [ ] GÃ©nÃ©rer une clÃ© master Fernet unique (`generate_encryption_key.py`)
- [ ] Stocker la clÃ© dans un gestionnaire de secrets (Vault, Dokploy, 1Password)
- [ ] Configurer `.env` avec `ENCRYPTION_MASTER_KEY` (permissions 600)
- [ ] Ajouter `.env` au `.gitignore`
- [ ] Activer HTTPS sur le reverse proxy (Let's Encrypt)
- [ ] Limiter l'accÃ¨s DB/Redis au rÃ©seau Docker interne
- [ ] Configurer les audit logs (`audit_logs` table)
- [ ] Tester l'encryption/decryption (tests unitaires)
- [ ] Documenter la procÃ©dure de rotation de clÃ©s
- [ ] DÃ©finir un plan de backup (DB + secrets)
- [ ] Configurer le rate limiting sur les endpoints sensibles
- [ ] Activer les logs structurÃ©s (JSON) pour monitoring
- [ ] Mettre en place des alertes (Ã©checs de sync, accÃ¨s anormaux)

---

## 6.10 Ressources & rÃ©fÃ©rences

### Documentation officielle
- **Cryptography (Fernet)** : https://cryptography.io/en/latest/fernet/
- **FastAPI Security** : https://fastapi.tiangolo.com/tutorial/security/
- **OWASP Top 10** : https://owasp.org/www-project-top-ten/
- **NIST Encryption Standards** : https://csrc.nist.gov/publications/

### Outils recommandÃ©s
- **Secret scanning** : `truffleHog`, `GitGuardian`
- **Static analysis** : `bandit` (Python), `semgrep`
- **Dependency scanning** : `pip-audit`, `safety`
- **Container scanning** : `trivy`, `grype`

### Exemples de politique de sÃ©curitÃ©
```markdown
# Security Policy

## Reporting a vulnerability
Please report security issues to: security@yourdomain.com
Response time: < 48h

## Supported versions
| Version | Supported |
|---------|-----------|
| 1.x     | âœ…        |
| 0.x     | âŒ        |

## Security features
- Encryption at-rest (Fernet AES-128)
- RBAC (Commissioner/Player/Spectator)
- Audit logging
- Rate limiting
- HTTPS-only in production
```

---

**Fin du document SECURITY.md** âœ…
